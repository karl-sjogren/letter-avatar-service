using System.Globalization;
using System.Text;
using LetterAvatars.Generator;
using Org.XmlUnit.Builder;
using Org.XmlUnit.Diff;
using SixLabors.ImageSharp.PixelFormats;

namespace LetterAvatars.Service.Tests;

public class SvgAvatarGeneratorTests {
    [Theory]
    [InlineData("en-US")]
    [InlineData("sv-SE")]
    [InlineData("ru")]
    [InlineData("ar")]
    public async Task OutputsCorrectNumberFormatsAsync(string culture) {
        Thread.CurrentThread.CurrentCulture = new CultureInfo(culture);

        var fontProvider = new DefaultFontProvider();
        var generator = new SvgAvatarGenerator(fontProvider);

        var bytes = await generator.GenerateAvatarAsync("SX", 512, Rgba32.ParseHex("fff"), Rgba32.ParseHex("000"));
        var xml = Encoding.UTF8.GetString(bytes!);

        var control = Input.FromString("<?xml version=\"1.0\" encoding=\"utf-8\"?><svg width=\"512\" height=\"512\" xmlns=\"http://www.w3.org/2000/svg\"><rect width=\"100%\" height=\"100%\" fill=\"#000000\" /><path stroke=\"#FFFFFF\" fill=\"#FFFFFF\" d=\"M254.48752 266.86237L 254.48752 266.86237C 231.84607 260.35413 215.36914 252.3563 205.05675 242.86888L 205.05675 242.86888L 205.05675 242.86888C 194.74435 233.38147 189.58815 221.67117 189.58815 207.73798L 189.58815 207.73798L 189.58815 207.73798C 189.58815 191.97147 195.89017 178.932 208.49422 168.61961L 208.49422 168.61961L 208.49422 168.61961C 221.09827 158.30722 237.48352 153.15102 257.64996 153.15102L 257.64996 153.15102L 257.64996 153.15102C 271.39984 153.15102 283.66016 155.80933 294.43088 161.12595L 294.43088 161.12595L 294.43088 161.12595C 305.2016 166.44255 313.54318 173.77582 319.45563 183.12572L 319.45563 183.12572L 319.45563 183.12572C 325.36804 192.47562 328.32428 202.69635 328.32428 213.78792L 328.32428 213.78792L 301.78705 213.78792L 301.78705 213.78792C 301.78705 201.68803 297.93707 192.1777 290.23715 185.25694L 290.23715 185.25694L 290.23715 185.25694C 282.53723 178.33618 271.67484 174.8758 257.64996 174.8758L 257.64996 174.8758L 257.64996 174.8758C 244.63345 174.8758 234.48146 177.74036 227.19403 183.46945L 227.19403 183.46945L 227.19403 183.46945C 219.9066 189.19858 216.26288 197.15057 216.26288 207.32549L 216.26288 207.32549L 216.26288 207.32549C 216.26288 215.48373 219.72327 222.38158 226.64404 228.01901L 226.64404 228.01901L 226.64404 228.01901C 233.5648 233.65646 245.34384 238.81267 261.9812 243.48761L 261.9812 243.48761L 261.9812 243.48761C 278.61853 248.16257 291.63507 253.31877 301.03082 258.95624L 301.03082 258.95624L 301.03082 258.95624C 310.42654 264.59366 317.39313 271.1707 321.9306 278.68726L 321.9306 278.68726L 321.9306 278.68726C 326.46808 286.20386 328.7368 295.04962 328.7368 305.22452L 328.7368 305.22452L 328.7368 305.22452C 328.7368 321.44934 322.41187 334.443 309.76196 344.20538L 309.76196 344.20538L 309.76196 344.20538C 297.1121 353.96777 280.19977 358.849 259.02496 358.849L 259.02496 358.849L 259.02496 358.849C 245.2751 358.849 232.4419 356.2136 220.52534 350.9428L 220.52534 350.9428L 220.52534 350.9428C 208.6088 345.67203 199.41931 338.45337 192.95686 329.28677L 192.95686 329.28677L 192.95686 329.28677C 186.49443 320.12018 183.26321 309.71613 183.26321 298.0746L 183.26321 298.0746L 209.80046 298.0746L 209.80046 298.0746C 209.80046 310.17447 214.26917 319.73062 223.20657 326.74304L 223.20657 326.74304L 223.20657 326.74304C 232.14398 333.7555 244.08344 337.26172 259.02496 337.26172L 259.02496 337.26172L 259.02496 337.26172C 272.95816 337.26172 283.6372 334.42004 291.06213 328.7368L 291.06213 328.7368L 291.06213 328.7368C 298.48706 323.05353 302.19952 315.30774 302.19952 305.4995L 302.19952 305.4995L 302.19952 305.4995C 302.19952 295.69128 298.7621 288.10593 291.88715 282.74347L 291.88715 282.74347L 291.88715 282.74347C 285.0122 277.38104 272.54565 272.08734 254.48752 266.86237\" /></svg>").Build();
        var test = Input.FromByteArray(bytes).Build();
        var diff = new DOMDifferenceEngine();
        diff.DifferenceListener += (comparison, outcome) => {
            Assert.Fail("Found a difference: " + comparison);
        };
        diff.Compare(control, test);
    }
}
